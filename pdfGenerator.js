const PDFDocument = require('pdfkit');
const fs = require('fs');
const path = require('path');

// Ensure output directory exists
function ensureOutputDir() {
    const outputDir = path.join(__dirname, 'generated-pdfs');
    if (!fs.existsSync(outputDir)) {
        fs.mkdirSync(outputDir, { recursive: true });
    }
    return outputDir;
}

// Generate PDF with 2-column layout, bold title, 11pt font
async function generatePDF(song) {
    return new Promise((resolve, reject) => {
        try {
            const outputDir = ensureOutputDir();
            const fileName = `${song.title.replace(/[^a-zA-Z0-9]/g, '_')}_${Date.now()}.pdf`;
            const filePath = path.join(outputDir, fileName);
            
            // Create PDF document - 8.5 x 11 inches (US Letter)
            const doc = new PDFDocument({
                size: [612, 792], // 8.5" x 11" in points (72 points per inch)
                margins: {
                    top: 40,    // Reduced from 50 to maximize space
                    bottom: 40, // Reduced from 50 to maximize space
                    left: 30,   // Reduced from 40 to maximize space
                    right: 30   // Reduced from 40 to maximize space
                }
            });
            
            // Pipe to file
            doc.pipe(fs.createWriteStream(filePath));
            
            // Page dimensions - maximized space usage
            const pageWidth = doc.page.width - doc.page.margins.left - doc.page.margins.right;
            const columnWidth = (pageWidth - 15) / 2; // Reduced gap from 20 to 15px
            const leftColumnX = doc.page.margins.left;
            const rightColumnX = leftColumnX + columnWidth + 15;
            
            // Title - Bold and centered
            doc.fontSize(16)
               .font('Helvetica-Bold')
               .text(song.title.toUpperCase(), leftColumnX, doc.y, {
                   width: pageWidth,
                   align: 'center'
               });
            
            // Artist - Below title
            doc.fontSize(12)
               .font('Helvetica')
               .text(`by ${song.artist}`, leftColumnX, doc.y + 5, {
                   width: pageWidth,
                   align: 'center'
               });
            
            // Add some space
            doc.moveDown(1.5); // Reduced from 2 to save space
            
            // Set font for lyrics - 11pt as requested
            doc.fontSize(11)
               .font('Helvetica');
            
            // Sequential column distribution (maintains order)
            const { leftSections, rightSections } = distributeSequentially(song.lyrics || [], doc, columnWidth);
            
            // Current Y position for both columns
            let currentY = doc.y;
            const startY = currentY;
            
            // Render Left Column
            doc.x = leftColumnX;
            doc.y = currentY;
            renderLyricsSequentially(doc, leftSections, leftColumnX, columnWidth);
            
            // Render Right Column
            doc.x = rightColumnX;
            doc.y = startY;
            renderLyricsSequentially(doc, rightSections, rightColumnX, columnWidth);
            
            // Footer
            doc.fontSize(8)
               .font('Helvetica')
               .text(`Generated by Discord Song Bot - ${new Date().toLocaleDateString()}`, 
                     leftColumnX, doc.page.height - 30, {
                       width: pageWidth,
                       align: 'center'
                     });
            
            // Finalize PDF
            doc.end();
            
            // Wait for PDF to be written
            doc.on('end', () => {
                console.log(`âœ… PDF generated: ${fileName}`);
                resolve(filePath);
            });
            
            doc.on('error', (error) => {
                console.error('PDF generation error:', error);
                reject(error);
            });
            
        } catch (error) {
            console.error('Error in generatePDF:', error);
            reject(error);
        }
    });
}

// Sequential column distribution - maintains original order and maximizes space
function distributeSequentially(lyrics, doc, columnWidth) {
    const maxColumnHeight = doc.page.height - 120; // Maximized available height
    const lineHeight = doc.currentLineHeight();
    
    let currentHeight = 0;
    let leftColumn = [];
    let rightColumn = [];
    let useLeftColumn = true;
    
    for (const line of lyrics) {
        const trimmedLine = line.trim();
        
        // Estimate line height
        let estimatedLineHeight = lineHeight;
        if (trimmedLine === '') {
            estimatedLineHeight = lineHeight * 0.3; // Empty line
        } else if (trimmedLine.startsWith('[') && trimmedLine.endsWith(']')) {
            estimatedLineHeight = lineHeight * 1.3; // Section header
        }
        
        // Check if we need to switch to right column
        if (useLeftColumn && currentHeight + estimatedLineHeight > maxColumnHeight * 0.85) {
            useLeftColumn = false;
            currentHeight = 0;
        }
        
        // Add line to appropriate column
        if (useLeftColumn) {
            leftColumn.push(line);
            currentHeight += estimatedLineHeight;
        } else {
            rightColumn.push(line);
            currentHeight += estimatedLineHeight;
        }
    }
    
    return { leftSections: [leftColumn], rightSections: [rightColumn] };
}

// Render lyrics sequentially with proper formatting
function renderLyricsSequentially(doc, sections, columnX, columnWidth) {
    for (const section of sections) {
        for (const line of section) {
            const trimmedLine = line.trim();
            
            if (trimmedLine === '') {
                // Empty line - minimal space
                doc.moveDown(0.2);
            } else if (trimmedLine.startsWith('[') && trimmedLine.endsWith(']')) {
                // Section headers - BOLD with small spacing
                doc.font('Helvetica-Bold')
                   .text(line, columnX, doc.y, { width: columnWidth });
                doc.font('Helvetica');
                doc.moveDown(0.1);
            } else if (isChordLine(trimmedLine)) {
                // Chord lines - BOLD
                doc.font('Helvetica-Bold')
                   .text(line, columnX, doc.y, { width: columnWidth });
                doc.font('Helvetica');
            } else {
                // Lyrics - NORMAL font
                doc.font('Helvetica')
                   .text(line, columnX, doc.y, { width: columnWidth });
            }
        }
    }
}

// Check if a line contains chords - Smart detection
function isChordLine(line) {
    const trimmed = line.trim();
    
    // Empty lines are not chord lines
    if (trimmed.length === 0) return false;
    
    // Section headers are not chord lines
    if (trimmed.startsWith('[') && trimmed.endsWith(']')) return false;
    
    // Look for chord patterns
    const chordPatterns = [
        /\b[A-G][#b]?(m|maj|min|sus|aug|dim|add)?[0-9]?\b/g,  // Standard chords
        /\b[A-G][#b]?\/[A-G][#b]?\b/g,                        // Slash chords like C/G
        /\b[A-G][#b]?\s+[A-G][#b]?\b/g                        // Space-separated chords
    ];
    
    let chordCount = 0;
    for (const pattern of chordPatterns) {
        const matches = trimmed.match(pattern);
        if (matches) chordCount += matches.length;
    }
    
    // Check for common lyric words that indicate it's NOT a chord line
    const lyricWords = /\b(the|and|you|me|my|i|a|to|in|is|of|for|with|will|love|god|lord|jesus|heart|life|time|way|day|night|see|know|come|go|take|give|said|say|never|always|every|all|when|where|what|how|why|can|could|would|should|was|were|been|being|have|has|had|do|does|did|get|got|make|made|let|put|call|find|keep|feel|think|want|need|help|tell|ask|try|turn|look|show|work|play|move|live|die|born|sing|dance|walk|run|fly|fall|rise|stand|sit|lay|sleep|wake|dream|hope|pray|praise|worship|holy|spirit|heaven|earth|water|fire|light|dark|sun|moon|star|sky|mountain|valley|river|ocean|tree|flower|bird|wind|rain|snow|peace|joy|grace|mercy|faith|truth|power|glory|name|word|voice|hand|eye|face|soul)\b/i;
    
    // Strong indicators this is a chord line:
    // 1. Has multiple chord patterns
    // 2. Relatively short line
    // 3. Doesn't contain many lyric words
    // 4. Has chord-like spacing patterns
    
    const hasMultipleChords = chordCount >= 2;
    const isShortLine = trimmed.length <= 60;
    const hasLyricWords = lyricWords.test(trimmed);
    const hasChordSpacing = /^[A-G][#b]?(\w{0,3})\s+[A-G][#b]?(\w{0,3})/.test(trimmed);
    
    // Chord line if:
    // - Has multiple chords AND is short AND doesn't have lyric words
    // - OR has chord spacing pattern
    // - OR line is mostly chord symbols (high chord density)
    
    const chordDensity = chordCount / trimmed.split(' ').length;
    
    return (hasMultipleChords && isShortLine && !hasLyricWords) ||
           hasChordSpacing ||
           chordDensity > 0.6;
}

module.exports = {
    generatePDF,
    distributeSequentially,
    renderLyricsSequentially,
    isChordLine
};
